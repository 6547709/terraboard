<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Terraboard</title>

        <base href="/" />

        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

        <link rel="stylesheet" href="static/terraboard.css" type="text/css">
        <script src="//code.jquery.com/jquery-1.11.3.min.js" type="text/javascript"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js" type="text/javascript"></script>

        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.6.5/angular.min.js"></script>
    </head>

    <body ng-app="terraboard">
        <div class="navbar navbar-default navbar-fixed-top">
            <div class="container">

                <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-menu">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://www.camptocamp.com">
                        <img alt="Camptocamp" src="static/c2c-logo.png">
                    </a>
                </div>

                <ul class="nav navbar-nav navbar-collapse collapse" id="navbar-collapse-menu">
                    <li class="dropdown" ng-controller="tbListCtrl">
                        <a id="reports-list-button" class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
                            Choose a statefile
                            <span class="caret"></span>
                        </a>
                        <ul id="reports-list" class="dropdown-menu">
                            <li ng-repeat="k in keys"><a href="state/{{k}}" target="_self">{{k}}</a></li>
                        </ul>
                    </li>
                </ul>

                <ul id="breadcrumb" class="nav navbar-nav navbar-right breadcrumb" ng-controller="tbBreadCtrl">
                    <li class="navbar-text" id="crumb-node">{{path}}</li>
                </ul>
            </div>
        </div>
        <div id="maincont" class="container" ng-controller="tbStateCtrl">
            <div id="mainrow" class="row">
                <div id="leftcol" class="col-md-4">
                    <div class="panel-group">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                              <h4 class="panel-title">General Information</h4>
                            </div>
                            <ul class="list-group">
                                <li class="list-group-item">Terraform version: {{details.terraform_version}}</li>
                                <li class="list-group-item">Serial: {{details.serial}}</li>
                                <li class="list-group-item">Version: <select ng-model="selectedVersion" ng-options="version as date for (version, date) in versions"></select></li>
                            </ul>
                        </div>
                        <div id="nodes" class="panel panel-info">
                            <div class="panel-heading">
                                <h4 class="panel-title">Modules</h4>
                            </div>
                            <ul id="nodeslist" class="list-group" ng-init="display.mod=undefined">
                                <li class="list-group-item" ng-repeat="mod in details.modules track by $index" ng-init="modname = mod.path[1] ? mod.path[1] : 'root'" ng-class="{selected: mod == selectedmod}">
                                    <div ng-click="display.mod = (display.mod != $index) ? $index : undefined" class="node-name">{{modname}} <span class="badge pull-right" ng-cloak>{{Utils.keys(details.modules[$index].resources).length}}</span></div>
                                    <ul ng-show="display.mod==$index" class="list-group" ng-init="indexmod=$index">
                                        <li ng-repeat="(n, m) in details.modules[$index].resources" ng-click="setSelected(indexmod, n)" class="list-group-item resource">{{n}}</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        <!--
                        <div class="panel-group">
                            <div class="panel panel-info">
                                <div class="panel-heading">
                                    <h4 class="panel-title">Details</h4>
                                </div>
                                <code>{{details}}</code>
                            </div>
                        </div>
                        !-->
                    </div>
                </div>
                <div id="node" class="col-md-8">
                    <h2 class="node-title">{{details.modules[selectedmod].path[1]}} / {{selectedres}}</h2>
                    <div class="panel-group">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <h4 class="panel-title">Attributes</h4>
                            </div>
                            <table class="table">
                                <thead><th>Attribute</th><th>Value</th></thead>
                                <tbody>
                                    <tr ng-repeat="(attr, val) in details.modules[selectedmod].resources[selectedres].primary.attributes">
                                        <td>{{attr}}</td><td>{{val}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
        </div>

        <script>
var app = angular.module("terraboard", [], function($locationProvider){
    $locationProvider.html5Mode(true);
});

app.controller("tbBreadCtrl", ['$scope', '$location', function($scope, $location) {
    $scope.$on('$locationChangeSuccess', function() {
        $scope.path = $location.path();
    });
}]);

app.controller("tbListCtrl", ['$scope', '$http', '$location', function($scope, $http, $location) {
    $http.get('api/states').then(function(response){
        $scope.keys = response.data;
    });
}]);

app.controller("tbStateCtrl", ['$scope', '$http', '$location', function($scope, $http, $location) {
    $scope.Utils = { keys : Object.keys };
    $scope.display = {};

    // Init
    $scope.selectedVersion = $location.search().versionid;

    var key = $location.url().replace('/state/', '');
    $http.get('api/history/'+key).then(function(response){
        $scope.history = response.data;
        $scope.versions = {};
        for (i=0; i<response.data.length; i++) {
            $scope.versions[response.data[i].VersionId] = new Date(response.data[i].LastModified).toLocaleString();
        }
        $scope.$watch('selectedVersion', function(ver) {
            $location.search('versionid', ver);
        });
    });

    $scope.$on('$locationChangeSuccess', function() {
        $http.get('api'+$location.url()).then(function(response){
            $scope.path = $location.path();
            $scope.details = response.data;
            $scope.setSelected = function(mod, res) {
                $scope.selectedmod = mod;
                $scope.selectedres = res;
            };
        });
    });
}]);
        </script>

    </body>
</html>
